<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KUBKAK Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #fff;
      padding: 10px;
      max-width: 600px;
      margin: auto;
    }
    button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      background: #2196f3;
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
    }
    #chat-box {
      border: 1px solid #444;
      height: 200px;
      overflow-y: scroll;
      padding: 5px;
      background: #1e1e1e;
      margin-bottom: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #333;
      margin-bottom: 10px;
    }
    canvas {
      display: block;
      margin: auto;
    }
  </style>
</head>
<body>

<h2>KUBKAK Wallet</h2>
<div id="wallet-address">Not connected</div>
<div id="wallet-balance">Balance: -</div>

<button onclick="connectWallet()">ğŸ”— à¹€à¸Šà¸·à¹ˆà¸­à¸¡ Wallet</button>

<h3>ğŸ“¤ à¹‚à¸­à¸™ Token</h3>
<input type="text" id="to" placeholder="à¹ƒà¸ªà¹ˆ address à¸œà¸¹à¹‰à¸£à¸±à¸šà¸«à¸£à¸·à¸­à¸ªà¹à¸à¸™ QR" />
<input type="number" id="amount" placeholder="à¸ˆà¸³à¸™à¸§à¸™ Token à¸—à¸µà¹ˆà¸ˆà¸°à¹‚à¸­à¸™" />
<button onclick="sendToken()">âœ… à¹‚à¸­à¸™</button>
<button onclick="openQRScanner()">ğŸ“· à¹‚à¸­à¸™à¸”à¹‰à¸§à¸¢ QR</button>

<h3>ğŸ“¥ à¸£à¸±à¸š Token (à¹à¸ªà¸”à¸‡ QR)</h3>
<div id="qr"></div>
<button onclick="generateQR()">ğŸ“Œ Show QR</button>
<button onclick="copyAddress()">ğŸ“‹ Copy Address</button>

<h3>ğŸ“ˆ à¸à¸£à¸²à¸Ÿ Token</h3>
<iframe src="https://www.geckoterminal.com/th/bkc/pools/0xf42d65b190bb78fb8ead8a92110b653722f96048?embed=1" width="100%" height="300" frameborder="0"></iframe>

<h3>ğŸ“š à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹‚à¸­à¸™</h3>
<div id="history"></div>

<h3>ğŸ’¬ Global Chat</h3>
<div id="chat-box"></div>
<input type="text" id="chat-input" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." />
<button onclick="sendMessage()">à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡</button>

<video id="video" width="100%" autoplay style="display:none;"></video>
<canvas id="canvas" hidden></canvas>

<script>
const tokenAddress = "0x4dc6f1fa9fd93f28d9b3b37592c572ba18bf6f10"; // Token: 1â‚¿illion Coin
const tokenABI = [
  "function transfer(address to, uint amount) returns (bool)",
  "function balanceOf(address owner) view returns (uint)",
  "event Transfer(address indexed from, address indexed to, uint amount)"
];

let provider, signer, address;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCQFmvFUxXl4O0S5WSKo9IZsxu9Esmbp6c",
  authDomain: "kubkakwallet.firebaseapp.com",
  databaseURL: "https://kubkakwallet-default-rtdb.firebaseio.com",
  projectId: "kubkakwallet",
  storageBucket: "kubkakwallet.appspot.com",
  messagingSenderId: "325567266889",
  appId: "1:325567266889:web:d74a2ccb4506bfa47bbf98",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function connectWallet() {
  const web3Modal = new Web3Modal.default({
    cacheProvider: false,
    providerOptions: {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: { 96: "https://rpc.bitkubchain.io" },
        },
      },
    },
  });

  const instance = await web3Modal.connect();
  provider = new ethers.providers.Web3Provider(instance);
  signer = provider.getSigner();
  address = await signer.getAddress();
  document.getElementById("wallet-address").textContent = `Connected: ${address}`;

  const balance = await provider.getBalance(address);
  document.getElementById("wallet-balance").textContent = `Balance: ${ethers.utils.formatEther(balance)} KUB`;

  generateQR();
  loadHistory();
}

async function sendToken() {
  const to = document.getElementById("to").value;
  const amount = document.getElementById("amount").value;
  const contract = new ethers.Contract(tokenAddress, tokenABI, signer);
  const tx = await contract.transfer(to, ethers.utils.parseUnits(amount, 18));
  await tx.wait();
  alert("à¹‚à¸­à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
  loadHistory();
}

function generateQR() {
  document.getElementById("qr").innerHTML = "";
  QRCode.toCanvas(document.createElement("canvas"), address, function (err, canvas) {
    if (err) console.error(err);
    else document.getElementById("qr").appendChild(canvas);
  });
}

function copyAddress() {
  navigator.clipboard.writeText(address);
  alert("à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¹‰à¸§");
}

function loadHistory() {
  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = "Loading...";
  const contract = new ethers.Contract(tokenAddress, tokenABI, provider);
  contract.queryFilter("Transfer", -5000).then(events => {
    const filtered = events.filter(e => e.args.from === address || e.args.to === address).reverse();
    historyDiv.innerHTML = filtered.map(e =>
      `<div>${e.args.from === address ? "ğŸ“¤" : "ğŸ“¥"} ${e.args.to} : ${ethers.utils.formatUnits(e.args.amount, 18)} Token</div>`
    ).join("");
  });
}

// --------------------------- Global Chat -----------------------------
function listenForMessages() {
  const chatBox = document.getElementById("chat-box");
  db.ref("messages").on("child_added", (snapshot) => {
    const data = snapshot.val();
    const msg = document.createElement("div");
    msg.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}
function sendMessage() {
  const input = document.getElementById("chat-input");
  const text = input.value.trim();
  if (!text) return;
  db.ref("messages").push({
    name: address || "Unknown",
    text: text,
    time: new Date().toISOString()
  });
  input.value = "";
}
listenForMessages();

// --------------------- QR Scanner ---------------------
function openQRScanner() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
      video.style.display = "block";
      const interval = setInterval(() => {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          document.getElementById("to").value = code.data;
          stream.getTracks().forEach(track => track.stop());
          video.style.display = "none";
          clearInterval(interval);
        }
      }, 500);
    });
}
</script>

<!-- jsQR à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹à¸à¸™ QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

</body>
</html>
