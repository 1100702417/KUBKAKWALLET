<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KUBKAK Wallet</title>
  <!-- SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body{font-family:sans-serif;background:#f0f2f5;margin:0;padding:20px;}
    .container{max-width:800px;margin:auto;background:#fff;padding:20px;border-radius:12px;}
    button{margin:5px;padding:10px;border:none;background:#2b90d9;color:#fff;border-radius:6px;cursor:pointer;}
    input{padding:5px;margin:5px;}
    nav{display:flex;gap:10px;margin-top:20px;}
    nav button{flex:1;background:#eee;color:#333;}
    nav button.active{background:#2b90d9;color:#fff;}
    .section{display:none;margin-top:20px;}
    .section.active{display:block;}
    #chat-box{border:1px solid #ccc;height:200px;overflow-y:scroll;padding:10px;background:#fafafa;color:#000;}
    .chat-msg b{color:#2b90d9;}
  </style>
</head>
<body>
<div class="container">
  <h2>ğŸŒ KUBKAK Wallet (Bitkub Chain)</h2>
  <div id="wallet-info">Not connected</div>
  <button onclick="connectWallet()">ğŸ”— Connect Wallet</button>
  <button onclick="logout()">Logout</button>
  <div><b>ğŸ’° Token Balance:</b> <span id="balance">-</span></div>
  <div><b>ğŸ“ˆ Price:</b> <span id="price">Loading...</span></div>
  <nav>
    <button onclick="showSection('send')" id="tab-send">ğŸ“¤ à¹‚à¸­à¸™</button>
    <button onclick="showSection('receive')" id="tab-receive">ğŸ“¥ à¸£à¸±à¸š</button>
    <button onclick="showSection('history')" id="tab-history">ğŸ§¾ à¸›à¸£à¸°à¸§à¸±à¸•à¸´</button>
    <button onclick="showSection('chart')" id="tab-chart">ğŸ“ˆ à¸à¸£à¸²à¸Ÿ</button>
    <button onclick="showSection('chat')" id="tab-chat">ğŸ’¬ à¹à¸Šà¸—</button>
  </nav>

  <!-- Sections -->
  <div id="section-send" class="section"><h3>ğŸ“¤ Send Token</h3><input id="to" placeholder="Recipient address"/><input id="amount" type="number" placeholder="Amount"/><button onclick="sendToken()">Send</button><button onclick="openScanner()">ğŸ“· QR Send</button><h4>ğŸ§¾ Receipt</h4><pre id="receipt"></pre></div>
  <div id="section-receive" class="section"><h3>ğŸ“¥ Receive Token</h3><div id="my-address">Your address: -</div><button onclick="openQRModal()">ğŸ“² Show QR</button><button onclick="openRequestQR()">ğŸ“¥ Request QR</button></div>
  <div id="section-history" class="section"><h3>ğŸ“œ Transfer History</h3><table><thead><tr><th>Time</th><th>To</th><th>Amount</th><th>TX</th></tr></thead><tbody id="history"></tbody></table></div>
  <div id="section-chart" class="section"><h3>ğŸ“ˆ Token Chart</h3><iframe src="https://www.geckoterminal.com/bitkub_chain/pools/0x559be194fb9d3b8993971f3ec4aad6d1f5beb635?embed=1&info=0&swaps=0&grayscale=0&light_chart=0&chart_type=price&resolution=1month"></iframe></div>
  <div id="section-chat" class="section"><h3>ğŸ’¬ Global Chat</h3><div id="chat-box"></div><input id="chat-msg" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..."/><button onclick="sendChat()">à¸ªà¹ˆà¸‡</button></div>
</div>

<!-- Modals -->
<div id="qrModal" class="modal">... </div>
<div id="scannerModal" class="modal">... </div>
<div id="requestQRModal" class="modal">... </div>

<script>
const tokenAddress="0x13b24b0E332683254e2B33c74b8109982E673Eec";
const tokenDecimals=18; const providerOptions={};
const web3Modal=new window.Web3Modal.default({cacheProvider:true,providerOptions});
let provider,signer,userAddress;

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyCQFmvFUxXl4O0S5WSKo9IZsxu9Esmbp6c",
  authDomain:"kubkakwallet.firebaseapp.com",
  databaseURL:"https://kubkakwallet-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"kubkakwallet",
  storageBucket:"kubkakwallet.appspot.com",
  messagingSenderId:"325567266889",
  appId:"1:325567266889:web:d74a2ccb4506bfa47bbf98"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* Show sections */
function showSection(id){
 document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
document.getElementById('section-'+id).classList.add('active');
document.getElementById('tab-'+id).classList.add('active');}

/* Connect wallet */
async function connectWallet(){
 try{
  const inst=await web3Modal.connect();
  provider=new ethers.providers.Web3Provider(inst);
  signer=provider.getSigner(); userAddress=await signer.getAddress();
  document.getElementById("wallet-info").innerText="Connected: "+userAddress;
  document.getElementById("my-address").innerText="Your address: "+userAddress;
  getBalance(); listenToChat();
 }catch(e){alert(e.message);}
}
function logout(){web3Modal.clearCachedProvider();location.reload();}

/* KNS resolver via contract `nameOf` */
const knsAddress="0xYourKNSContractAddressHere"; let knsContract=null;
async function resolveKNS(addr){
 if (!provider) return shorten(addr);
 if (!knsContract){
  knsContract=new ethers.Contract(knsAddress, ["function nameOf(address) view returns(string)"], provider);
 }
 try{ const nm=await knsContract.nameOf(addr); return nm||shorten(addr);}catch(e){return shorten(addr);}
}
function shorten(a){return a.slice(0,6)+"â€¦"+a.slice(-4);}

/* Chat */
function listenToChat(){
 const box=document.getElementById("chat-box"); box.innerHTML="";
 db.ref("chat").orderByChild("timestamp").limitToLast(100)
 .on("child_added", async snap=>{
  const {sender,msg}=snap.val();
  const name=await resolveKNS(sender);
  const div=document.createElement("div");
  div.className="chat-msg";
  div.innerHTML=`<b>${name}</b>: ${msg}`;
  box.appendChild(div); box.scrollTop=box.scrollHeight;
 });
}
function sendChat(){
 const msg=document.getElementById("chat-msg").value.trim(); if(!msg||!userAddress)return;
 db.ref("chat").push({sender:userAddress,msg,timestamp:Date.now()});
 document.getElementById("chat-msg").value="";
}

/* Other: sendToken, QR modal, fetchPrice, loadHistory, etc. à¸•à¹‰à¸™à¸‰à¸šà¸±à¸šà¸­à¸¢à¸¹à¹ˆà¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡ unchanged */
</script>
</body>
</html>
