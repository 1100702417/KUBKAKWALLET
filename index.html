<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KUBKAK Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Ethers + Web3Modal -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <!-- QR code -->
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f1f1f;
      padding: 10px;
      text-align: center;
      font-size: 24px;
    }
    main {
      padding: 20px;
    }
    button {
      margin: 5px;
      padding: 10px;
      border: none;
      background: #00c896;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    #chat-box {
      background: #1f1f1f;
      height: 200px;
      overflow-y: scroll;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      margin: 5px 0;
      border: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .modal.show {
      display: flex;
    }
  </style>
</head>
<body>
  <header>KUBKAK Wallet</header>
  <main>
    <div id="wallet-address">Not Connected</div>
    <button onclick="connect()">Connect Wallet</button>
    <button onclick="sendToken()">Send Token</button>
    <button onclick="openQRModal()">Receive (Show QR)</button>
    <button onclick="openScanner()">Scan QR to Send</button>

    <h3>Global Chat</h3>
    <div id="chat-box"></div>
    <input id="chat-input" placeholder="Type a message" />
    <button onclick="sendMessage()">Send</button>
  </main>

  <!-- Modal for QR -->
  <div id="qrModal" class="modal" onclick="this.classList.remove('show')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>Wallet QR Code</h3>
      <div id="qr-code"></div>
      <p>Click outside to close</p>
    </div>
  </div>

  <!-- Modal for Scanner -->
  <div id="scannerModal" class="modal" onclick="this.classList.remove('show')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>Scan QR Code</h3>
      <div id="reader" style="width: 300px;"></div>
      <p>Click outside to close</p>
    </div>
  </div>

  <script>
    const providerOptions = {};
    const web3Modal = new window.Web3Modal.default({ cacheProvider: true, providerOptions });
    let provider, signer, address;

    const tokenAddress = "0x4dc6f1fa9fd93f28d9b3b37592c572ba18bf6f10"; // 1â‚¿illion Coin
    const tokenAbi = [
      "function transfer(address to, uint amount) public returns (bool)",
      "function balanceOf(address owner) public view returns (uint256)"
    ];

    async function connect() {
      provider = new ethers.providers.Web3Provider(await web3Modal.connect());
      signer = provider.getSigner();
      address = await signer.getAddress();
      document.getElementById("wallet-address").textContent = "Connected: " + address;
    }

    async function sendToken() {
      const to = prompt("Enter recipient address:");
      const amount = prompt("Enter amount to send:");
      const token = new ethers.Contract(tokenAddress, tokenAbi, signer);
      const decimals = 18;
      const tx = await token.transfer(to, ethers.utils.parseUnits(amount, decimals));
      alert("Transaction sent: " + tx.hash);
    }

    // === QR Code Generation ===
    function openQRModal() {
      const qrDiv = document.getElementById("qr-code");
      qrDiv.innerHTML = "";
      const qr = new QRCodeStyling({
        width: 250,
        height: 250,
        data: address || "Connect wallet first",
        dotsOptions: { color: "#00FFAA", type: "rounded" },
        backgroundOptions: { color: "#121212" }
      });
      qr.append(qrDiv);
      document.getElementById("qrModal").classList.add("show");
    }

    // === QR Scanner ===
    function openScanner() {
      document.getElementById("scannerModal").classList.add("show");
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decoded) => {
          html5QrCode.stop();
          document.getElementById("scannerModal").classList.remove("show");
          if (confirm("Send token to " + decoded + "?")) {
            const amount = prompt("Enter amount:");
            const token = new ethers.Contract(tokenAddress, tokenAbi, signer);
            const tx = await token.transfer(decoded, ethers.utils.parseUnits(amount, 18));
            alert("Sent: " + tx.hash);
          }
        },
        err => {}
      );
    }

    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyCQFmvFUxXl4O0S5WSKo9IZsxu9Esmbp6c",
      authDomain: "kubkakwallet.firebaseapp.com",
      databaseURL: "https://kubkakwallet-default-rtdb.firebaseio.com",
      projectId: "kubkakwallet",
      storageBucket: "kubkakwallet.appspot.com",
      messagingSenderId: "325567266889",
      appId: "1:325567266889:web:d74a2ccb4506bfa47bbf98",
      measurementId: "G-HVNMX35LRQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function listenForMessages() {
      const chatBox = document.getElementById("chat-box");
      db.ref("messages").on("child_added", (snapshot) => {
        const data = snapshot.val();
        const msg = document.createElement("div");
        msg.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    function sendMessage() {
      const input = document.getElementById("chat-input");
      const text = input.value.trim();
      if (!text) return;
      const name = address || "Anonymous";
      db.ref("messages").push({ name, text, time: new Date().toISOString() });
      input.value = "";
    }

    window.addEventListener("load", () => {
      listenForMessages();
    });
  </script>
</body>
</html>
