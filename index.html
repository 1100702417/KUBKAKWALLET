<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KUBKAK Wallet</title>

  <!-- Library -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #0a0a0a;
      color: white;
      padding: 20px;
    }
    button { padding: 10px; margin: 5px; }
    input { padding: 5px; width: 100%; margin: 5px 0; }
    .section { display: none; margin-top: 20px; }
    .active { display: block; }
    #chat-box { height: 200px; overflow-y: scroll; background: #111; padding: 10px; margin-top: 10px; }
    #nav button { background: #1e1e1e; color: white; border: 1px solid #444; }
  </style>
</head>
<body>

<h2>KUBKAK Wallet</h2>
<div id="wallet-info">Not Connected</div>
<button onclick="connectWallet()">üîå Connect Wallet</button>

<div id="nav">
  <button onclick="showSection('send')">üí∏ ‡πÇ‡∏≠‡∏ô</button>
  <button onclick="showSection('receive')">üì• ‡∏£‡∏±‡∏ö</button>
  <button onclick="showSection('history')">üïì ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
  <button onclick="showSection('chart')">üìä ‡∏Å‡∏£‡∏≤‡∏ü</button>
  <button onclick="showSection('chat')">üí¨ ‡πÅ‡∏ä‡∏ó</button>
</div>

<!-- SECTION: ‡∏™‡πà‡∏á -->
<div class="section" id="send">
  <h3>‡πÇ‡∏≠‡∏ô Token</h3>
  <input type="text" id="to" placeholder="Recipient Address">
  <input type="number" id="amount" placeholder="Amount">
  <button onclick="sendToken()">‚úÖ ‡πÇ‡∏≠‡∏ô</button>
</div>

<!-- SECTION: ‡∏£‡∏±‡∏ö -->
<div class="section" id="receive">
  <h3>QR ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô</h3>
  <div id="qr"></div>
  <p id="my-address"></p>
</div>

<!-- SECTION: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<div class="section" id="history">
  <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</h3>
  <div id="tx-history"></div>
</div>

<!-- SECTION: ‡∏Å‡∏£‡∏≤‡∏ü -->
<div class="section" id="chart">
  <h3>‡∏£‡∏≤‡∏Ñ‡∏≤ Token</h3>
  <iframe src="https://www.geckoterminal.com/th/bkc/pools/0xf42d65b190bb78fb8ead8a92110b653722f96048?embed=1"
          width="100%" height="400" style="border: none;"></iframe>
</div>

<!-- SECTION: ‡πÅ‡∏ä‡∏ó -->
<div class="section" id="chat">
  <h3>üí¨ Global Chat</h3>
  <div id="chat-box"></div>
  <input type="text" id="chat-msg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
  <button onclick="sendChat()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
</div>

<script>
const tokenAddress = "0x4dc6f1fa9fd93f28d9b3b37592c572ba18bf6f10"; // 1‚Çøillion Coin
const tokenDecimals = 18;
const providerOptions = {};
const web3Modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions });
let provider, signer, userAddress;

const firebaseConfig = {
  apiKey: "AIzaSyCQFmvFUxXl4O0S5WSKo9IZsxu9Esmbp6c",
  authDomain: "kubkakwallet.firebaseapp.com",
  databaseURL: "https://kubkakwallet-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kubkakwallet",
  storageBucket: "kubkakwallet.appspot.com",
  messagingSenderId: "325567266889",
  appId: "1:325567266889:web:d74a2ccb4506bfa47bbf98"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function showSection(id){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function connectWallet(){
  try {
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    document.getElementById("wallet-info").innerText = "Connected: " + userAddress;
    document.getElementById("my-address").innerText = userAddress;
    loadHistory();
    showQR(userAddress);
    listenToChat();
  } catch (err) {
    alert(err.message);
  }
}

async function sendToken(){
  const to = document.getElementById("to").value;
  const amount = document.getElementById("amount").value;
  const contract = new ethers.Contract(tokenAddress, [
    "function transfer(address to, uint amount) returns (bool)"
  ], signer);
  const tx = await contract.transfer(to, ethers.utils.parseUnits(amount, tokenDecimals));
  await tx.wait();
  saveTxHistory(to, amount);
  alert("‡πÇ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

function saveTxHistory(to, amount){
  db.ref("history").push({
    from: userAddress,
    to,
    amount,
    timestamp: Date.now()
  });
}

function loadHistory(){
  const box = document.getElementById("tx-history");
  box.innerHTML = "";
  db.ref("history").orderByChild("timestamp").limitToLast(100).on("child_added", snap => {
    const d = snap.val();
    const div = document.createElement("div");
    div.textContent = `${shorten(d.from)} ‚Üí ${shorten(d.to)} : ${d.amount}`;
    box.appendChild(div);
  });
}

function showQR(address){
  const qr = new QRCodeStyling({
    width: 200,
    height: 200,
    data: address,
    dotsOptions: { color: "#ffffff", type: "rounded" },
    backgroundOptions: { color: "#000000" }
  });
  document.getElementById("qr").innerHTML = "";
  qr.append(document.getElementById("qr"));
}

function shorten(addr){
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}

// üî• CHAT SYSTEM
function listenToChat(){
  const box = document.getElementById("chat-box");
  db.ref("chat").orderByChild("timestamp").limitToLast(100).on("child_added", snap => {
    const { sender, msg } = snap.val();
    const div = document.createElement("div");
    div.innerHTML = `<b>${shorten(sender)}</b>: ${msg}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  });
}

function sendChat(){
  const msg = document.getElementById("chat-msg").value.trim();
  if(!msg) return;
  db.ref("chat").push({
    sender: userAddress,
    msg,
    timestamp: Date.now()
  });
  document.getElementById("chat-msg").value = "";
}
</script>

</body>
</html>
